\documentclass[10pt,a4paper]{article}
\input{./preamble.tex}

\title{Additive Combinatorics}
\begin{document}
\maketitle
\tableofcontents
\newpage
\setcounter{section}{-1}
\section{Elementary Tools}
Asymptotic notation: for functions $f, g$ we will write $f = O(g)$ to mean there is a constant $c > 0$ such that, for large enough $x$, $|f(x)| \leq c|g(x)|$. Sometimes, we will write $f = O_h(g)$ if $c$ depends on $h$. We will also sometimes write $f \ll g$ to mean $f=O(g)$ (or indeed $g \gg f$, or $f \ll_h g$). We will also write such things as $(x+h)^2 = x^2 + O_h(x)$. We will often write $\log X$ - it will typically be irrelevant which base, but it will be assumed that $X$ is large.

All sets will be finite and nonempty unless otherwise specified. Usually, they will be subsets of some abelian group, denoted by $G$. If finite, we will write $N = |G|$, for instance $G = \Z/N\Z$ or $\F_p^n$ (where $N = p^n$). Much of what we do is valid for any abelian group, some of it only for finite groups, and some only for specific groups. Often, it can be generalised and sometimes not - e.g. $\F_p^n$ vs $\Z/N\Z$.

We will write $\one_A(x)$ for the indicator function on a subset $A \subseteq G$, i.e. $\one_A(x) = 1$ if $x \in A$, and $0$ if not. We also define the convolution of functions $f, g:G \to G$ by \[(f \ast g)(x) = \sum_{y \in G}f(y)g(x-y) = \sum_{y+z=x}f(y)g(z)\]
We define the ``difference convolution'' by
\[(f \circ g)(x) = \sum_{z\in G}f(x+z)g(z) = \sum_{y-z = x}f(y)g(z)\]

We define an inner product on function $G \to \C$ by
\[\angle{f,g} = \sum_{x\in G}f(x)\overline{g(x)}\]
We have the trivial but useful adjoint property that
\[\angle{f\ast g, h} = \angle{f, h \circ \bar{g}}\]
which follows from $x+y=z \iff x = z-y$.

\section{Sum Sets}
Given $A, B \subset G$ we define
\begin{align*}
  A+B &\coloneqq \{a+b : a \in A, b\in B\}\\
  A-B &\coloneqq \{a-b : a \in A, b\in B\}
\end{align*}
Note that these are set operations, and don't necessarily follow any nice algebraic properties. For instance $(A+B)-B \neq A$, and in general is a much larger set.

We have trivial bounds $|A|\leq |A+B| \leq |A||B|$ - the first follows as, for fixed $b$, $\{a+b:a \in A\}$ is a set of size $|A|$ contained in $A+B$, and the second follows as $+$ is a surjection $A \times B \surjection A+B$.

When $A=B$, this surjection maps $(a_1, a_2)$ and $(a_2,a_1)$ to the same element, and hence $|A+A| \leq \frac{|A|(|A|+1)}{2} = \frac{1}{2}|A|^2 + O(|A|)$.

Are these trivial bounds sharp?

If $A$ is a subgroup, then $|A+A| = |A|$ (or if $A$ is a coset of a subgroup).

If $A = \{1,2,4,\ldots, 2^k\}$, then $|A+A| = \frac{|A|(|A|+1)}{2}$, as all pairwise sums are distinct. We can also have $A = \{1,4,16,\ldots, 2^{2k}\}, B = \{2,8,\ldots,2^{2k+1}\}$, and get $|A+B| = |A||B|$.
\begin{lemma}
  $|A+A| \leq |A| \iff A$ is a coset of a subgroup.
\end{lemma}
\begin{proof}
  Since both properties are invariant under translation, without loss of generality take $0 \in A$. So $A \subseteq A+A$, so since $|A+A| = |A|$, we must have $A = A+A$. Hence $A$ is closed under addition. For any $a \in A$ there are $|A|$ many distinct translates $a+a'$ for $a' \in A$. By closure, these are all in $A$, and so one must be $0$. Hence $a+a' = 0$, and we have inverses.
\end{proof}
In groups where there are many finite subgroups, we have many $A$ such that $|A+A| = |A|$. What about in $\Z$? Here, there are no nontrivial finite subgroups, and so this result tells us that, if $|A|>1$, then $|A+A| > |A|$.
\begin{lemma}
  If $A \subset \Z$ then $|A+A| \geq 2|A|-1$. Equality holds if and only if $A$ is an arithmetic progression (i.e. $|A+A| < 2|A| \implies A$ is an arithmetic progression).
\end{lemma}
\begin{proof}
  Suppose we order $A$ like $\{a_1 < a_2 < \ldots a_n\}$. This induces an ordering on some elements of $A+A$:
  \[2a_2 < a_1+a_2 < a_1+a_3 < \ldots < a_1+a_n < a_2 + a_n < a_3 + a_n < \ldots < 2a_n\]
  This gives $2n-1$ distinct sums in $A+A$.

  For the second part, it suffices to show that if equality holds then, for any $1 \leq i < n$ there is some $j > i$ with $a_j - a_i = a_2-a_1$, as then $a_j = a_1 + (j-1)(a_2-a_1)$, and we have an arithmetic progression.

  Consider for $2 \leq i < n$, the sum $a_2 + a_i \in A+A$. Since $|A+A| = 2n-1$, the above ordered list is all of $A+A$, and so one of them is $a_2+a_i$. Since $i< n$, $a_2 + a_i < a_j + a_n$ for all $2 \leq j \leq n$, and so $a_2 + a_i = a_1 + a_j$.
\end{proof}
What about if $A \subseteq \F_p$, for $p$ a prime?
\begin{lemma}[Cauchy-Davenport]
    If $A, B \subset \F_p$, then $|A+B| \geq \min(|A|+|B|-1,p)$.
\end{lemma}
\begin{proof}
  We fix $B \subset \F_p$, and then prove the inequality for all $A\subset \F_p$ by induction on $|B|$.

  When $|B| = 1$, this is trivial, since $|A+B| = |A| = \min(|A|,p)$.

  Suppose that $|B|\geq 2$, so we have $b_1\neq b_2$ distinct elements of $B$, and let $z = b_1-b_2 \neq 0$. If $A+z\subset A$ then, for any fixed $a \in A$, we have $a+z \in A$, so $a+kz \in A$ for all $k \in \N$ by induction on $k$. Hence $A = \F_p$, as $\F_p$ is cyclic, and so we are done as $|A+B| = p = \min(|A|+|B|-1,p)$.

  Otherwise, $A+z \nsubseteq A$, and so there exists $a \in A$ such that $a+z \notin A$. Let $x = a-b_1$. Then $B+x$ contains some element not in $A$, namely $a+z = b_2+x$, and some element in $A$, namely $a=b_1+x$.

  So $1\leq |A\cap (B+x)| < |B|$. Now note that:
  \[A+B \supseteq ((A-x)\cup B) + (A\cap(B+x))\]
  To verify this, if $a'+b' \in RHS$, then either:
  \begin{enumerate}
    \item $a' \in A-x$. Then since $b' \in B+x$, $a'+b' \in A+B-x+x = A+B$.
    \item $a' \in B$. Then since $b' \in A$, $a'+b' \in A+B$.
  \end{enumerate}
  Hence if $A' = (A-x)\cup B, B' = A\cap(B+x)$, then $1\leq |B'| < |B|, |A'+B'| \leq |A+B|$. By induction, $|A+B| \geq \min(|A'|+|B'|-1,p)$.

  But $|A'| = |(A-x)\cup B| = |A-x| + |B| - |(A-x)\cap B| = |A|+|B|-|B'|$. Hence $|A|+|B| = |A'|+|B'|$.
\end{proof}
This trick, transforming from $(A,B) \to ((A-x)\cup B, A\cap (B+x))$, is sometimes called the \emph{Dyson e-transform}.

We can characterise the case of equality as APs: if $|A+B| = |A|+|B|-1$ then, aside from edge cases, $A$ and $B$ must be APs of the same step seize (``Vosper's Theorem'').

We say that $A$ has \emph{small doubling} if $|A+A| \leq K|A|$ where $K$ is ``small'' (e.g. $O(1)$). We've seen two examples of sets with small doubling:
\begin{itemize}
  \item Cosets of subgroups ($K=1$).
  \item Arithmetic progressions ($K = 2-\frac{1}{|A|} = 2+O(1)$).
\end{itemize}
There are two ways to generate new sets with small doubling from old.
\begin{enumerate}
  \item \underline{Pass to a large subset.} If $|A+A| \leq K|A|$ and $X \subset A$, then $|X+X| \leq |A+A| \leq \left(K\frac{|A|}{|X|}\right)|X|$. If $|X| \geq K^{-O(1)}|A|$, then $A$ has doubling $K$ implies $X$ has doubling at most $K^{O(1)}$.
  \item \underline{Pass to a sumset.} If $|A+A|\leq K|A|$ and $X = A+Y$, then $|X+X| \leq |A+A+Y+Y| \leq |Y|^2|A+A| \leq (K|Y|^2)|X|$. So if $A$ has doubling $K$ and $X = A+Y$ where $|Y| \leq K^{O(1)}$, then $X$ has doubling $\leq K^{O(1)}$. In fact it suffices if $|Y+Y| \leq K^{O(1)}|Y|$ and $|X| \geq K^{-O(1)}|A||Y|$.
\end{enumerate}
This accounts for all sets with small doubling. That is, if $|A+A| \leq 100|A|$, then $A$ is obtained from a coset or AP via these two operations. We'll state this more precisely and prove it later on.
\subsection{Sumset Calculus}
How are the sizes of sumsets related to each other?
\begin{lemma}[Ruzsa's Triangle Inequality]
  For any sets $A,B,C$, $|A+B| \leq \frac{|A+C||B-C|}{|C|}$.
\end{lemma}
\begin{proof}
  For each $x = A+B$, fix an arbitrary representation $x=a_x+b_x$. Consider the map $C\times(A+B) \to (A+C)\times (B-C)$ given by $(c,x)\mapsto (c+a_x,b_x-c)$. This is clearly well defined - to finish the proof we will show that it is injective.

  Note that we can recover $x$ from the image of $(c,x)$ by noting $(c+a_x) + (b_x-c) = a_x+b_x = x$. Then we can also recover $c$ by subtracting $a_x$ from $c+a_x$, and hence this map is injective.
\end{proof}
What about iterated sumsets? We write $kA$ for the k-fold sumset of $A$, i.e. the set of all sums $a_1+ \ldots + a_k$ where $a_i \in A$.

Note that $|A| \leq |kA| \leq |A|^k$. This does not mean $A$ dilated by $k$!

If $|A$ is small, we might want to know whether $|A+A|$ being small implies that $|kA|$ are also relatively small? The answer turns out to be yes! This is known as Pl\"unnecke's inequality, which says that if $|A+A|\leq K|A|$, then $|kA|\leq K^k|A|$. The original proof by Pl\"unnecke is graph-theoretic - it can be found in Tao \& Vu. More recently, Petridis has found an alternative proof which is presented here. It uses the following lemma:
\begin{lemma}[Pl\"unnecke-Petridis Inequality]
  For any $A, B$ there exists $X \subseteq A$ such that, for all $C$
  \[\frac{|C+X+B|}{|C+X|} \leq \frac{|A+B|}{|A|} \tag{$\ast$}\]
\end{lemma}
\begin{proof}
  Note that $(\ast)$ holds whenever $|C|=1$, and hence
  \[\frac{|X+B|}{|X|}\leq \frac{|A+B|}{|A|}\tag{$\ast \ast$}\]
  We will chose $X \subseteq A$ such that $(\ast\ast)$ holds and $\frac{|X+B|}{|X|}$ is minimal. Note that $X = A$ satisfies $(\ast\ast)$, and so this choice makes sense.

  We then show that $(\ast)$ holds for all $C$ by induction on $|C|$. The case $|C|=1$ is immediate.

  Now suppose that $|C|> 1$, and choose some $c \in C$, and let $C' = C\setminus\{c\}$. Then:
  \[C+X = (C'+X)\sqcup (c+X')\]
  for some $X' \subseteq X$, maximal such that $C'+X$ and $c+X'$ are disjoint. By maximality, $c+(X\setminus X')\subseteq C'+X$, and so $c + (X\setminus X') + B\subseteq C'+X+B$. Hence:
  \[C+X+B = (C'+X+B)\cup((C+X+B)\setminus(c+X\setminus X' +B))\]
  Taking cardinalities of both sides,
  \begin{align*}
    |C+X+B| &\leq |C'+X+B|+|c+X+B| - |c+X\setminus X' +B|\\
    &= |C'+X+B| + |X+B| - |X\setminus X' + B|\\
    &\leq \frac{|A+B|}{|A|}|C'+X| + |X+B| - \frac{|X+B|}{|X|}|X\setminus X'|
  \end{align*}
  using the inductive hypothesis and the fact that $\frac{|X\setminus X'+B|}{|X\setminus X'|} \geq \frac{|X+B|}{|X|}$ by minimality. Continuing, we have:
  \begin{align*}
    |C+X+B| &\leq \frac{|A+B|}{|A|}|C'+X| + |X+B|\left(1-\frac{|X\setminus X'}{|X|}\right)\\
    &= \frac{|A+B|}{|A|}|C'+X| + \frac{|X+B|}{|X|}|X'|\\
    &\leq \frac{|A+B|}{|A|}(|C'+X|+|X'|)\\
    &= \frac{|A+B|}{|A|}|C+X|
  \end{align*}
\end{proof}
\begin{corollary}[Pl\"unnecke's Inequality]
  If $|A+B|\leq K|A|$, then there exists $X \subseteq A$ such that, for all $k\geq 1$,
  \[|X+kB| \leq K^k|X|\]
  In particular, $|kB| \leq K^{k}|A|$.
\end{corollary}
\begin{proof}
  This follows immediately from the Pl\"unnecke-Petridis Inequality by induction on $k$. For $k=1$, we have $|X+B|\leq K|X|$, by taking any $C$ with $|C|=1$. In general, take $C = (k-1)B$, and then
  \[|X+kB| = |C+X+B| \leq K|X+C| = K|X+(k-1)B| \leq K\cdot K^{k-1}|X| = K^k|X|\]
  by induction. The second claim follows since trivially,
  \[|kB| \leq |X+kB| \text{ and } K^k|X| \leq K^k|A|\]
\end{proof}
By coupling this with Ruzsa's triangle Inequality (RTI), we get a form for mixed sums and differences.
\begin{corollary}
  Suppose $|A+B|\leq K|A|$. For any $k, \ell \in \N$ with $k+\ell \geq 2$,
  \[|kB - \ell B| \leq K^{k+\ell}|A|\]
\end{corollary}
\begin{proof}
  By RTI with $X$ as above,
  \[|kB-\ell B| \leq \frac{|X+kB||X+\ell B|}{|X|} \leq \frac{K^k|X|K^\ell|X|}{|X|} =K^{k+\ell}|X| \leq K^{k+\ell}|A|\]
\end{proof}
\subsection{Additive Energy}
The size of the sumset is one way to measure the `structure' of $A$, but not the only way. One advantage of using $\frac{|A+A|}{|A|}$ is that it controls the same quantity for subsets automatically: i.e., if $X \subset A$, then $|X+X| \leq |A+A|$. However, it has the disadvantage that $\frac{|A+A|}{|A|}$ can grow out of control quickly if we add in a small number of elements. It's often more convenient to use ``additive energy'' to measuer structure.
\begin{definition}
  The \emph{additive energy} of $A$, $E(A)$ is defined to be
  \[E(A) = \#\{(a,b,c,d) \in A^4: a+b=c+d\}\]
\end{definition}
Note that while small sumsets occur in `structured' sets, here this corresponds to large additive energy. For example, if $A$ is an arithmetic progression, then $E(A) \approx |A|^3$.

If $A$ is a geometric progression, then $E(A) \approx |A|^2$, as $2^k + 2^\ell = 2^r + 2^s \iff \{k,\ell\} = \{r,s\}$.

We have an alternate definition of $E(A)$ - note that
\begin{align*}
  E(A) &= \sum_{a,b \in A} \sum_{c,d \in A} \sum_x \one_{a+b=x}\one_{c+d=x}\\
  &= \sum_x\left(\sum_{a,b\in A} \one_{a+b=x}\right)^2\\
  &= \sum_x \one_A \ast \one_A(x)^2\\
  &= \norm{\one_A \ast \one_A}_2^2
\end{align*}
(recall that the $L^p$ norm of $f:G \to \C$ is defined by $\norm{f}_p = \left(\sum_x |f(x)|^p\right)^{1/p}$, and $\norm{f}_\infty = \sum_{x\in G}|f(x)|$).

Its status as an $L^2$-norm explains why $E(A)$ is so useful in analytic arguments. Also note that the size of the sumset $|A+A|$ is the size of the support of $\one_A \ast \one_A$, sometimes called the ``$L^0$-norm''. Note that the $L^1$-norm of $A$ is $\sum_{a,b \in A}\sum_x \one_{a+b=x} = \sum_{a,b\in A} 1 = |A|^2$.

It should also be noted that
\begin{align*}
  E(A) &= \#\{(a,b,c,d) \in A^4 : a-c=b-d\}\\
  &= \sum_x \one_A \circ \one_A(x)^2 = \norm{\one_A\circ\one_A}_2^2
\end{align*}
\begin{lemma}
  $|A|^2 \leq E(A) \leq |A|^3$ and $E(A) \geq \frac{|A|^4}{|A+A|}$.
\end{lemma}
i.e., small sumset $\implies$ large energy.
\begin{proof}
  $|A|^2 \leq E(A)$ comes from counting solutions to $a+b=c+d$ where $a=c$ and $b=d$.

  $E(A)\leq |A|^3$ is because once we have fixed $a,b,c$, then either there are 1 or 0 choices for $d$.

  To connect $E(A)$ with the size of the sumset, we use the Cauchy-Schwarz inequality, i.e.
  \[\sum a_ib_i \leq \left(\sum|a_i|^2\right)^{1/2}\left(\sum |b_i|^2\right)^{1/2}\]
  We have
  \begin{align*}
    |A|^2 &= \sum_x \one_A\ast \one_A(x) \times 1\\
    &= \sum_x \one_A\ast \one_A(x) \times \one_{A+A}(x)\\
    &\leq \left(\sum_x \one_A \ast \one_A(x)^2\right)^{1/2}\left(\sum_x\one_{A+A}(x)^2\right)^{1/2}\\
    &= E(A)^{1/2}|A+A|^{1/2}
  \end{align*}
  Similarly, we have $E(A) \geq \frac{|A|^4}{|A-A|}$.
\end{proof}
The converse to small sumset $\implies$ large energy does not hold. If we take $A$ to be the union of an arithmetic progression and geometric progression of equal sizes, then $|A+A| \gg |A|^2$ (from the geometric progression), but $E(A) \gg |A|^3$ (from the arithmetic progression).

$A$ itself is not structured much, but a large subset of $A$ is. One might hope that this construction is the only thing that can go wrong. More precisely, that if $A$ has large energy, then there is a large subset of $A$ with small doubling. The answer to this hope is yes! - the Balog-Szemer\'edi-Gowers Lemma.
\begin{lemma}[Balog-Szemer\'edi-Gowers]
  If $E(A) \geq K^{-1} |A|^3$ for some $K \geq 1$, then there exists $A' \subseteq A$ such that:
  \begin{enumerate}
    \item $|A'| \gg K^{-1}|A|$
    \item $|A'-A'| \ll K^7 |A|$.
  \end{enumerate}
\end{lemma}
Note that the dependence on $K$ is polynomial, and also that we can recover a bound for $|A'+A'|$ via the Ruzsa triangle inequality:
\[|A'+A'| \leq \frac{|A'+A'|\cdot |A'+A'|}{|A'|} \leq K^{14}|A|\]
We will use the ``first moment method'' -  a simple application of probability which is very useful in combinatorics. It essentially says that if $X$ is a real-valued random variable then $X \geq \E X$ with positive probability.
\begin{proof}[Proof (following Schoen).]
  Firstly, we will find a large subset $X \subset A$ such that there are `many' differences in $X-X$ with `many' different representations as elements of $A-A$. Note that, if all of $A-A$ had $\geq K^{-O(1)}|A|$ representations, then $E(A) = \sum_x \one_A \circ \one_A (x)^2 \geq |A-A|K^{-O(1)}|A|^2$, and on the other hand $\leq |A|^3$, then $|A-A| \leq K^{O(1)}|A|$.

  We will then find some $X' \subseteq X$ such that $|X'-X'|$ is small as required. We'll break these steps up into the following lemmas.
\end{proof}
\begin{lemma}
  If $E(A) \geq K^{-1}|A|^3$ then for any $0 < c < 1$ there is some $X \subseteq A$ such that $|X| \gg K^{-1}|A|$ and for all but at most $c|X|^2$ many pairs $(a,b)\in X^2$,
  \[\one_A\circ \one_A (a-b) \gg c^2 K^{-3}|A|\]
\end{lemma}
\begin{proof}
  The set $X$ will be of the form $A \cap (A+s)$ for some $s \in A-A$ randomly chosen. We choose $s \in A-A$ with probability $\frac{\one_A \circ \one_A(s)}{|A|^2}$. Then:
  \begin{align*}
    \E |X| &= \sum_s \P(s \text{ chosen})|A \cap (A+s)|\\
    &= \sum_s \frac{\one_A\circ \one_A(s)}{|A|^2}\sum_{a \in A}\one_A(a-s)\\
    &= \frac{1}{|A|^2}\sum_s \one_A \circ \one_A(s)^2\\
    &= \frac{E(A)}{|A|^2}
  \end{align*}
  For any $G \subset A^2$, we calculate $\E |X^2 \cap G|$.

  Using linearity of expectation:
  \begin{align*}
    \E |X^2 \cap G| &= \sum_{(a,b) \in G} \P(a,b \in X)\\
    &= \sum_{(a,b) \in G}\sum_s \frac{\one_A\circ \one_A(s)}{|A|^2}\one_A(a-s)\one_A(b-s)\\
    &= \frac{1}{|A|^2}\sum_{(a,b) \in G} \sum_s \one_A \circ \one_A(s)\one_A(a-s)\one_A(b-s)
  \end{align*}
  We bound the inner sum above by Cauchy-Schwarz:
  \begin{align*}
    \sum_s \one_A \circ \one_A(s) \one_A(a-s)\one_A(b-s) & \leq \left(\sum_s \one_A\circ \one_A(s)^2\right)^{1/2}\left(\sum_{s\in G} \one_A(a-s)\one_A(b-s)\right)^{1/2}\\
    &= E(A)^{1/2}\one_A\circ \one_A(a-b)^{1/2}
  \end{align*}
  It then follows that:
  \[\E|X^2\cap G| \leq \frac{E(A)^{1/2}}{|A|^2} \sum_{(a,b)\in G} \one_A \circ \one_A(a-b)^{1/2}\]
  In particular, if $G \subset A^2$ is the set of pairs $(a,b)$ such that:
  \[\one_A \circ \one_A(a-b) \leq \frac{c^2}{4}\frac{E(A)^3}{|A|^8}\]
  then
  \[\E|X^2 \cap G| \leq \frac{c}{2}\frac{E(A)^2}{|A|^4}\]
  using the trivial bound that $|G| \leq |A|^2$.

  Furthermore, by Cauchy-Schwarz again, $\E |X|^2 \geq (\E |X|)^2$, so $\E|X|^2 \geq \frac{E(A)^2}{|A|^4}$.

  Hence, by the first moment method, there is some $X \subseteq A$ such that
  \[|X|^2 -\frac{1}{c}|X^2 \cap G| \geq \frac{1}{2}\frac{E(A)^2}{|A|^4}\]

  Hence we have:
  \begin{enumerate}
    \item $|X|^2 \geq \frac12 \frac{E(A)^2}{|A|^4} \geq \frac12 \frac{|A|^2}{K^2}$, so $|X| \gg \frac{|A|}{K}$.
    \item $|X^2 \cap G| \leq c|X|^2$
  \end{enumerate}
\end{proof}
It remains to find some large $A'\subset X$ such that $|A'-A'|$ is small.
\begin{proof}[Proof of BSG.]
  We apply the previous lemma to $A$ with $c = \frac18$, to obtain some $X$ as stated.

  Since $\one_A \circ \one_A(a-b) = \one_A\circ \one_A(b-a)$, we can define a graph $H$ with vertex set $X$, such that $a,b$ are connected by an edge in $H$ if and only if $a \neq b$ and $\one_A \circ \one_A(a-b) \gg K^{-3}|A|$.

  By \textbf{Lemma 4.4}, there are at most $\frac18|X|^2$ many pairs $(a,b) \in X^2$ where this condition fails, and hence $H$ has at least $\binom{|X|}{2} - \frac{1}{16}|X|^2$ edges.

  If $d(x)$ denotes the degree of a vertex $x \in H$, then:
  \[\sum_{x \in X} d(x) \geq \frac{7}{8}|X|^2 - |X|\]
  Let $A'$ be the subset of $X$ consisting of those elements of degree at least $\frac34|X|$ in $H$.

  The contribution to the degree count from $x \notin A'$ is at most $\frac{3}{4}|X|^2$, and hence:
  \[|X||A'| \geq\sum_{x \in A'} d(x) \geq \frac18 |X|^2-|X|\]
  and hence $|A'| \gg |X|$.

  We now claim that, for any $x \in A'-A'$, there at $\gg K^{-6}|A|^2 |X|$ many quadruples $(a_1,a_2,a_3,a_4) \in A^4$ such that $x=a_1-a_2+a_3-a_4$. Assuming this, since the number of such quadruples is at most $|A|^4$, we have:
  \[|A|^4 \gg |A'-A'|K^{-6}|A|^2|X|\]
  Then, rearranging we will have:
  \[|A'-A'| \ll K^6 \frac{|A|^2}{|X|} \ll K^7|A|\]
  Fix some $a,b \in A'$ such that $x = a-b$. By choice of $A'$, there are $\geq \frac12 |X|$ many $c \in X$ such that $(a,c), (b,c)$ are edges in $H$.

  Hence there are $\gg K^{-3}|A|$ many $(a_1,a_2) \in A^2$ such that $a_1-a_2 = a-c$ and $\gg K^{-3}|A|$ many $(a_3,a_4) \in A^2$ such that $a_3-a_4=b-c$. Since different $c$ give different quadruples for fixed $x$, in total we have:
  \[\gg\left(\frac12|X|\right)\left(K^{-3}|A|\right)\left(K^{-3}|A|\right)\gg |X|K^{-6}|A|\]
  many such quadruples.
\end{proof}
\textbf{Addendum/Big Picture Remarks.} The goal of BSG is to go from $E(A)$ is large (i.e. $\geq K^{-1}|A|^3$) to getting $A'\subset A$ with $|A'-A'| \ll |A'|$, where $A'$ is a `large' subset of $A$.

Recall that $E(A)$ is $\sum_x \one_A\circ\one_A(x)^2$, where $\one_A\circ\one_A(x)$ is the number of ways of writing $x$ as a difference in $A-A$.
dd
Let $S$ dbe the set $\{x: \one_A \circ \one_A(x) \geq \frac{1}{2K}|A|\}$ (note that trivially $\one_A\circ\one_A(x) \leq |A|$), so $x \in S$ implies that $x$ really can be written as a difference in a large number of ways. We want to know how big $S$ is.

One the one hand,
\[\sum_{x\notin S}\one_A\circ\one_A(x)^2 < \frac{1}{2K}|A|\sum_{x}\one_A\circ\one_A(x) = \frac{1}{2K}|A|^3\]

Now since $\sum_{x} \one_A\circ\one_A(x)^2 = \frac{1}{K}|A|^3$, we must have:
\[|S||A|^2 \geq \sum_{x\in S}\one_A\circ\one_A(x)^2 \geq \frac{1}{2K}|A|^3\]
and hence
\[|S| \gg \frac{1}{K}|A|\]
For an upper bound on $S$, we note that $|S|\frac{1}{2K}|A| \leq \sum_{x \in S}\one_A \circ\one_A(x) \leq \sum_x \one_A\circ\one_A(x) = |A|^2$, and so $|S| \ll K|A|$. So up to some constant terms, $|S|$ is essentially $|A|$.

Since $x \in S$ implies that $x$ is represented many times in $A-A$, we must have $S \subset A-A$. So we would be done if we could find $A'\subset A$ such that $A'-A' \subset S$.

This can't be done in general, but we can find a large $A'\subset A$ such that ``99\%'' of all pairs $(a',b') \in A'^2$ have $a'-b'\in S$ - this is \textbf{4.4}. Such an $S$ is often called a ``symmetry set''. We then want to get to a ``100\%'' statement: we know that 99\% of the $(a',b')$ have $a'-b'\in S$, so we expect for most $a',b' \in S$, there are $\gg |A'|$ many $c\in A'$ such that $a'-c, b'-c \in S$.

We then write $a'-b' = (a'-c)-(b'-c) \in S-S$. So we can write $a'-c \in S$ as $a_1-a_2$ in many ways, and likewise for $b'-c$. So $a'-b'$ can be written in $\gg K|A'||A|^2$ many ways, and so in total have $\gg |A'-A'||A|^3$ many such quadruples. But trivially there are at most $|A|^4$ quadruples, so $|A'-A'|\ll K|A|$.

\subsection{Covering}
We say that $A$ is $K$-covered by $B$ if there is $X$ with $|X| \leq K$ such that $A \subseteq X+B$. I.e., we can contain $A$ in at most $K$-many translates of $B$.

For example, if $A$ is $K$-covered by $B$, where $|B|\ll|A|$ and $|B|$ has small doubling, then $A$ must also have small doubling:
\[|A+A| \leq |X+X+B+B|\ll K^2|B+B|\ll_K |B| \ll |A|\]
We can often get more from covering than this suggests. For instance, we can control iterated sums: if $A+B$ is efficiently covered by $A$ itself, then so is $A+nB$ for small $n$. If $A+B \subset A+X$, then $A+nB \subset A+nX$.

Before we use this concept, we need to show how to produce efficient coverings. The first way is due to Ruzsa, and is simple and useful.
\begin{lemma}[Ruzsa Covering Lemma]
  If $|A+B|\leq K|B|$, then $A$ is $K$-covered by $B-B$.
\end{lemma}
\begin{proof}
  Let $X$ be maximal such that $(x+B)_{x\in X}$ are disjoint.

  We can control the size of $X$:
  \[|X||B|=|X+B| \leq |A+B| \leq K|A|\]
  and so $|X|\leq K$.

  If $a \in X$, then obviously $a\in X+B - B$. If $a \in A\setminus X$, then $a+B$ must intersect $x+B$ for some $x \in X$ (by maximality). I.e. there are $b_1, b_2 \in B$ such that $a+b_1 = x+b_2$. But then $a= x+b_1-b_2 \in X+B-B$, and so $A \subseteq X+B-B$.
\end{proof}
Note that we are covering $A$ by $B-B$, not $B$ itself. This is because $B-B$ is much `smoother' than $B$ itself - e.g. what if $B$ is a large random subset of $G$. On average, $G$ needs $\gg \log |G|$ translates of $B$ to cover everything, so even though $|G+B| \leq |G| \ll |B|$, but if $G \subset X+B$, then $X \gg \log |G|$ (with high probability). So $G$ is not efficiently covered by $B$, even though $|G+B|\ll |B|$. But $B-B = G$ with high probability. Indeed, any $B\subset G$ with $|B|>\frac12 |G|$ has $B-B=G$, since for any $x \in G$, consider $B$ and $x+B$. These are subsets of $G$ of size $>\frac12 |G|$, so they must intersect. I.e. there are $b_1, b_2 \in B$ with $b_1 = x+b_2$.

We now present an application of Ruzsa's covering lemma and Pl\"unnecke's inequality -  a non-trivial inverse sumset result.

As we saw earlier, if $H$ is a subgroup of $G$ and $A \subset x+H$ with $|A|\gg|H|$, then $|A+A| \ll |A|$. We will show that this is the only way that $A$ can have small doubling in groups of small torsion (e.g. $G = \F_p^n$, not in subsets of $\Z$ or $\Z/N\Z$).
\begin{theorem}
  If $A \subset \F_p^n$ is such that $|A+A|\leq K|A|$, then there is a subgroup $H \leq \F_p^n$ and $x$ such that $A \subseteq x+H$ and $|A|\gg_{p, K}|H|$.
\end{theorem}
\begin{proof}
  Without loss of generality, $0 \in A$. The idea is to take $H = \angle{A}$. But trivially we only have $|H|\leq p^{|A|}$ - we will use the small doubling of $A$ to control the size of $H$.

  We want to use Ruzsa's covering lemma - the obvious way is $|A+A|\leq K|A|$, so $|A|$ is $K$-covered by $A-A$. But $A$ is 1-covered by $A-A$ anyway, so this is useless. Instead, we will cover $A+A-A$ by $A-A$. Pl\"unnecke's inequality says that:
  \[|A+A-A+A| \leq K^4|A|\]
  and hence by Ruzsa's covering lemma, there is $X \subset 2A-A$ with $|X|\leq K^4$ and:
  \begin{align*}
    A+A-A &\subseteq X+A-A\\
    A+A+A-A & \subseteq X+(A+A-A) \subseteq X+X+A-A
  \end{align*}
  and so on. In general, we have for all $n \geq 1$, $nA+(A-A) \subseteq nX + (A-A)$. If $H_0 = \angle{X}$, then $|H_0| \ll_{p,K} 1$, because $|H_0| \leq p^{|X|} \leq p^{K^4} = C(p,K) \cdot 1$.

  Let $H = \angle{A}$. If $h \in H$, then $h \in nA$ for some $n \geq 1$, so:
  \[h \in nA \subseteq nA + (A-A) \subseteq nX + (A-A) \subseteq H_0 + (A-A)\]
  Hence $H \subseteq H_0 + (A-A)$. So $|A| \leq |H_0||A-A|\ll_{p,K} 1\cdot K^2|A| \ll_{p,K} |A|$.
\end{proof}
Note the essential use of bounded torsion, when we bounded $|H_0|\ll_{p,K} 1$. If we tried this in $\Z$, then $|H_0| = \infty$. Even in $\Z/N\Z$, if $|X|\geq 2$, then $H_0 = \angle{X} = \Z/N\Z$ (if $N$ is prime). Something similar does hold however if we replace `subgroup' by `arithmetic progression'.

The dependency on constants is $|H| \leq (K^2 p^{K^4}) |A|$. This has been improved - the best known bound is due to Green-Tao, Lovett, and Zohar, and is of the form $|H| \leq p^{o(K)} |A|$.

This is the best possible: if $|A| = K$ and $A$ is linearly independent over $\F_p$, then $|A+A|\leq |A|^2 \leq K|A|$, and the smallest cost containing $A$ has size $p^K$.

But, part of the need for this exponential dependence is that we insisted $A$ is $1$-covered by $H$.

Note in the example above, $A$, is $K$-covered by $\{0\}$. Now we expect that we can do polynomial bounds in $K$, but this is still open.
\begin{conjecture}[Marton]
 If $A \subset F_p^n$ has $|A+A|\leq K|A|$, then $A$ is $C$-covered by $H\leq \F_{p^n}$ with $|H| \leq |A|$, where $C = O_p(K^{O_p(1)})$.
\end{conjecture}
\begin{conjecture}[Polynomial Freiman-Ruzsa conjecture for $\F_p^n$]
 If $|A| \subset \F_p^n$ has $|A+A|\leq K|A|$, then there is $H \leq \F_p^n$ such that $|H|\ll_p K^{O_p(1)}|A|$ and $|A\cap(x+H)|\gg_p K^{-O_p(1)}|A|$.
\end{conjecture}
These conjectures are equivalent: assume Marton's conjecture. Then there is $X$ with $|X| \ll K^{O(1)}$ such that $A \subset X+H$ and $|H| \leq |A|$. Then by pigeonholing, there is some $x \in X$ such that $|A\cap (x+H)| \geq K^{-O(1)}|A|$. We'll see the other direction later on.

A similar form of PFR is conjectured for any abelian group, again replacing subgroups by arithmetic progressions.

\subsection{Span-Covering}
In covering, we wanted a ``small'' $X$ such that $A \subset X+B$. Sometimes, it's enough for $X$ to have ``low complexity'' (i.e. $X$ is spanned by a small number of elements).
\begin{definition}
  We say $A$ is $K$-span covered by $B$ if there is $X$ of size $|X| \leq K$ such that:
  \[A \subset \text{Span}(X) + B\]
  where $\text{Span}(X) = \{\sum_{x\in X}c_x x : c_x \in \{-1,0,1\}\}$.
\end{definition}
\begin{lemma}
  If $|A+A| \leq K|A|$ and $|A+B| \leq K'|B|$. Then $A$ is $O(K \log(KK'))$-span covered by $B-B$.
\end{lemma}
Note that if $K$ is fixed, we can view this as $O(\log K')$ dependence. So $|\text{Span}(X)| \approx 3^{\log(K')} \approx (K')^c$.
\begin{proof}
  We construct a sequence of sets $B_0, B_1, \ldots$ as follows: first, let $B_0 = B$. We then construct $B_{n+1}$ in terms of $B_n$.

  Suppose there are $2K$ many disjoint translates of $B_n$ of the form $a+B_n$ for $a \in A_n'$ disjoint, where $|A_n'| = 2K, A_n' \subseteq A$. Then we just let $B_{n+1}  A_n' + B_n$, and note that $|B_{n+1}| = 2K|B_n|$.

  Otherwise, let $A' \subseteq A$ be maximal such that $(a+B_n)$ for $a \in A'$ are disjoint, so $|A'| < 2K$. Now let $B_{n+1} = A' + B_n$ and stop the construction.

  We first show this construction must stop eventually. By induction, $B_n \subset B+nA$, so $(2K)^n|B| = |B_n| \leq |B_nA|$. Now,
  \begin{align*}
    |B+nA| &\leq \frac{|B+A||nA-A|}{|A|} \hspace*{3cm}(RTI)\\
    &\leq K'|B|K^{n+1} \hspace*{3cm}(\text{Pl\"unnecke})
  \end{align*}
  So $(2K)^n \leq K'K^{n+1}$, so $2^n \leq K'K$, so $n \leq \log_2(K'K)\ll \log(K' K)$. Hence we must stop at some $n = O(\log(KK'))$.

  We now claim that the span of $X = A_0' \cup \ldots \cup A_n'$ covers $A$ by $B-B$. Then we are done, since $|X|\leq \sum_{i=0}^n |A_n'| \leq 2K(n+1) \ll K \log(KK')$.

  Suppose that $a \in A$. We know that $a+B_n$ is not disjoint from $B_{n+1}$, since $A'$ was chosen to be maximally disjoint. So $a \in B_{n+1}-B_n$. Hence $A \subseteq B_{n+1} - B_n$. But $B_{n+1} = A_n' + A_{n-1}' + \ldots +A_0' + B$, $B_n = A_{n-1}' + \ldots +A_0'+B$.

  So $A \subseteq B_{n+1}-B_n = B-B + (A_0'-A_0') + \ldots +(A_{n-1}' -A_{n-1}') + A_n' \subseteq B-B + \text{Span}(X)$.
\end{proof}
\subsection{Finding Arithmetic Progressions}
What kind of conditions on a set of integers guarantee the existence of an arithmetic progression?
\begin{conjecture}[Baudet, 1920s]
  If $\Z$ is coloured red/blue, then there exist arbitrarily long APs of the same colour.
\end{conjecture}
For instance, any colouring of $\{1, \ldots, 9\}$ contains a monochromatic 3AP.
\begin{theorem}[van der Waerden]
  For any $r, k \geq 1$, if $\Z$ is $r$-coloured then there exists a monochromatic $k$-term arithmetic progression.
\end{theorem}
This is proven in the Part III course Ramsey Theory.

We might also ask which colour class contains the $k$-AP. Perhaps it is always the largest?
\begin{conjecture}
  For any $\delta > 0$, if $A \subset \Z$ has `density' $\delta$, then $A$ has arbitrarily long APs.
\end{conjecture}
This would imply VDW, since in an $r$-colouring there must be a colour class with density $\geq \frac{1}{r}$. This also turns out to be true:
\begin{theorem}[Szemer\'edi, 1975]
  For any $\delta > 0$ and $k \geq 1$ there exists $N \ll_{k, \delta} 1$ such that, if $N' \geq N$ and $A \subset \{1, \ldots, N'\}$ with $|A| \geq \delta N'$, then $A$ contains a $k$-term AP.
\end{theorem}
There are many different proofs - the combinatorial one by Sz\'emeredi, as well as ones via ergodic theory, hypergraph regularity, and an analytic proof by Gowers.

Let $r_k(N)$ be the size of the largest $A \subseteq \{1, \ldots, N\}$ such that $A$ has no $k$-term APs, so that Sz\'emeredi's theorem is that $\frac{r_k(N)}{N}\to 0$ as $N \to \infty$.
\begin{theorem}[Gowers]
  For all $k\geq 3$,
  \[r_k(N) \ll \frac{N}{(\log\log N)^{c_k}}\]
\end{theorem}
In this course we will focus on the case $k=3$. Let $r(N) = r_3(N)$.
\begin{theorem}[Roth, 1953]
  $\frac{r(N)}{N} \to 0$ as $N \to \infty$.
\end{theorem}
In fact, Roth proved $r(N) \ll \frac{N}{\log\log N}$. Roth used Fourier analysis. We will develop enough Fourier analysis to prove:
\begin{theorem}[Bourgain, 1999]
  $r(N) \ll \left(\frac{\log\log N}{\log N}\right)^{1/2}N$
\end{theorem}
\section{Fourier Analysis}
\subsection{Basic Concepts}
We will only be considering finite abelian groups. Let $G$ be a finite abelian group. A \emph{character} on $G$ is a group homomorphism $\gamma:G \to \C^\times$. Lower-case Greek letters will be reserved for characters, and lower-case Roman letters are for elements of $G$.

The set of characters can be made into a group with the group operation pointwise multiplication, and the identity the trivial character $\one(x) = 1 \forall x \in G$. This group is $\hat{G}$, the \emph{dual group} of $G$. Since multiplication in $\C$ is abelian, $\hat{G}$ is abelian. Since any character is a homomorphism, $\gamma(0) = 1$. Also, $\gamma(x)$ is a $|G|\th$ root of unity for any $x \in G$. Hence $\hat{G}$ is a finite abelian group.
\begin{lemma}
  $\hat{G}\cong G$
\end{lemma}
\begin{proof}
  Omitted. Straightforward with classification of finite abelian groups. Note it is obvious is $G$ is cyclic.
\end{proof}
For example, if $G = \Z/N\Z$, then any $\gamma \in \{1, \ldots, N\}$ induces a character by $\gamma(x) = e\left(\frac{\gamma x}{N}\right)$, where $e(z) = \exp(2\pi\im z)$. Or, if $G = \F_p^n$, then $\gamma \in \F_p^n$ gives a character $\gamma \in \hat{G}$ where $\gamma(x) = e\left(\frac{\gamma\cdot x}{p}\right)$.

When talking about $G$, we use the counting measure, the sum. With $\hat{G}$, we use the `normalised probability measure' $\frac{1}{N}\Sigma$, which we denote by $\E$.

We have a natural inner product for functions $f,g:G\to \C$:
\[\angle{f, g} = \sum_{x \in G} f(x)\overline{g(x)}\]
And, if $f,g : \hat{G} \to \C$, we use:
\[\angle{f,g} = \E_{\gamma \in \hat{G}} f(\gamma)\overline{g(\gamma)}\]
\begin{lemma}[Orthoganality]
  For any $\gamma \in \hat{G}$:
  \[\sum_{x \in G} \gamma(x) = \begin{cases} |G| & \gamma = \one \\ 0 & \ow\end{cases}\]
  For any $x \in G$:
  \[\E_{\gamma \in \hat{G}} \gamma(x) = \begin{cases} 1 & x = 0\\ 0 & \ow\end{cases}\]
\end{lemma}
\begin{proof}
  If $\gamma= \one$ or $x = 0$, this is trivial.

  Now suppose $\gamma \neq \one$, so there is $y \in G$ such that $\gamma(y) \neq 1$. If $S = \sum_{x\in G}\gamma(x)$, then:
  \begin{align*}
    \gamma(y)S &= \gamma(y)\sum_{x\in G} \gamma(x)\\
    &= \sum_{x \in G} \gamma(y)\gamma(x)\\
    &=  \sum_{x\in G} \gamma(y+x)\\
    &= \sum_{x\in G} \gamma(z) = S
  \end{align*}
  Hence $S = 0$. The second claim is similar, using $\lambda \in \hat{G}$ with $\lambda(x) \neq 1$.
\end{proof}
\subsection{Fourier Transform}
If $f: G \to \C$, then we define $\hat{f} : \hat{G} \to \C$ by:
\[\hat{f}(\gamma) = \sum_{x\in G} f(x)\overline{\gamma(x)} = \angle{f, \gamma}\]
\begin{lemma}[Parseval's Identity]
  For any $f, g : G \to \C$, we have:
  \[\angle{f, g} = \angle{\hat{f}, \hat{g}}\]
  In particular, $\norm{f}_2 = \norm{\hat{f}}_2$.
\end{lemma}
\begin{proof}
  \begin{align*}
    \angle{f,g} &= \sum_{x\in G} f(x) \overline{g(x)}\\
    &= \sum_{x,y \in G}f(x)\overline{g(y)}\one_{x=y}\\
    &= \sum_{x,y \in G}f(x)\overline{g(y)}\E_{\gamma \in \hat{G}}\gamma(y-x)\\
    &= \E_{\gamma \in \hat{G}}\left(\sum_{x\in G}f(x)\gamma(-x)\right)\left(\sum_{y\in G}\overline{g(y)}\gamma(y)\right)\\
    &= \E_{\gamma \in \hat{G}}\left(\sum_{x\in G} f(x)\overline{\gamma(x)}\right)\overline{\left(\sum_{y\in G} g(y)\overline{\gamma(y)}\right)}\\
    &= \angle{\hat{f}, \hat{g}}
  \end{align*}
\end{proof}
\begin{lemma}[Diagonalises convolution]
  Given $f, g:G \to \C$, we have:
  \[\widehat{f\ast g} = \hat{f}\cdot \hat{g}\]
\end{lemma}
\begin{proof}
  For any $\gamma \in \hat{G}$,
  \begin{align*}
    \widehat{f\ast g}(\gamma) &= \sum_{z\in G} f\ast g(z) \overline{\gamma}(z)\\
    &= \sum_{z\in G}\sum_{x,y \in G} f(x) g(y) \one_{x+y=z}\overline{\gamma(z)}\\
    &= \sum_{x,y \in G} f(x)g(y)\overline{\gamma(x+y)}\\
    &= \left(\sum_{x\in G}f(x)\overline{\gamma(x)}\right)\left(\sum_{y \in G}g(y)\overline{\gamma(y)}\right)
  \end{align*}
\end{proof}
\subsection{Roth's Theorem in $\F_{p^n}$}
Our goal is to prove Roth's thoerm in $\Z$ - if $A \subset \{1, \ldots, N\}$ and $|A|/N$ is large, then $A$ contains a 3AP. We will first prove a version of this in $\F_p^n$, and the proof for $\Z$ will be a ``translation'' of this proof.

Fix some odd prime $p\geq 3$ (in $p=2$, then 3APs are trivial as $x, x+d, x$ is a 3AP). Then a 3AP is  a set of the form $\{x, x+d, x+2d\}$ where $x, d \in \F_p^n$. We allow $d=0$, but call a 3AP with $d\neq 0$ `non-trivial'.

We're given $A \subseteq \F_p^n$ and we know its size or equivalently its \emph{density} $\alpha = |A|/p^n$. We want to deduce that $\alpha$ large implies $A$ has a non-trivial 3AP.

Two observations:
\begin{enumerate}
  \item This is easy if $A$ is very structured, e.g. if $A$ is a subspace.
  \item This is easy if $A$ is random. The expected number of 3APs in $A$ is approximately the sum over all 3APs in $\F_p^n$ of the probability that 3AP is contained in $A$, which is about $p^{2n} \times \alpha^3$. The number of trivial 3APs in $A$ is just $|A| = \alpha p^n$, so provided $\alpha^3 p^{2n}$ is much larger than $\alpha p^n$, the non-trivial count dominates, and there must be some non-trivial 3APs.
\end{enumerate}
Tao called this the ``structred vs randomness'' dichotomy - all sets should be structured to some degree and random to some degree, and so the theorem should be true.

Our proof will use the ``density increment strategy''.

Suppose that $A \subseteq \F_p^n$ has no non-trivial 3APs. We want to show that $\alpha = |A|/p^n$ is small.

Either:
\begin{enumerate}
  \item $A$ has $\gg \alpha^3 p^{2n}$ many 3APs, and hence either:
  \begin{enumerate}
    \item $\alpha$ is small - done.
    \item $A$ has a non-trivial 3AP - contradiction.
  \end{enumerate}
  \item $A$ is not well-distributed, and there is a large subspace $W \leq \F_p^n$ and a coset of $W$, say $x+W$, on which $A$ has increased density (i.e. $\frac{|A\cap (W+x)|}{|W|} \geq \alpha(1+c)$ for $c>0$).

  Then we zoom in on $A \cap (W+x)$ (or rather $(A-x)\cap W$, as being a 3AP is invariant under translation). $W \cong \F_p^{n-m}$ for some small $m$, and repeat.
\end{enumerate}
We can't repeat forever since $\alpha$ is bounded above by 1, so we eventually stop and are done.

The goal is:
\begin{theorem}[Meshulam, 1957]
  If $A \subseteq \F_p^n$ has no non-trivial 3APs, then $|A|\ll_p \frac{p^n}{n}$, and in particular, $\frac{|A|}{p^n} \to 0$ as $n \to \infty$.
\end{theorem}

Our main tool is:
\begin{lemma}
  Let $V$ be an $n$-dim vector space over $\F_p^n$ and let $A \subseteq V$ with density $\alpha$. Suppose that $A$ has no non-trivial 3APs. Then either:
  \begin{enumerate}
    \item $\alpha \leq \frac{\sqrt{2}}{p^{n/2}}$ or
    \item There is a subspace $V' \leq V$ of codimension 1, and $x \in V$ with:
    \[\frac{|(A-x)\cap V'|}{|V'|} \geq (1+\frac{\alpha}{4})\alpha\]
  \end{enumerate}
\end{lemma}
\begin{proof}[Proof of Meshulam using \textbf{Lemma 2.6}]
  Let $A \subseteq \F_p^n$ with density $\alpha > 0$ and no nontrivial 3APs. We want $\alpha \ll \frac{1}{n}$.

  If $\alpha \leq p^{-n/4}$, then we're done.

  It's also enough to prove this for large $n$ - if our proof showed that $\alpha \leq \frac{100}{n}$ for all $n \geq 1000$, then using $\alpha \leq 1$, we get that $\alpha \leq \frac{1000}{n}$ for all $n \geq 1$, and so $\alpha \ll \frac{1}{n}$ for all $n \geq 1$.

  Let $k \geq 0$ be maximal such that the following holds: there is a sequence of sets $A_0, \ldots, A_k$ and associated $V_0, \ldots, V_k$ vector spaces over $\F_p$ such that:
  \begin{enumerate}
    \item $A_0 = A, V_0 = \F_p^n$.
    \item $A_i \subseteq V_i$.
    \item $A_i$ has no nontrivial 3APs.
    \item If $\alpha_i = \frac{|A_i|}{|V_i|}$ then $\alpha_{i+1} \geq (1+\frac14\alpha_i)\alpha_i$ for all $0 \leq i < k$.
    \item $|V_{i+1}| = \frac{1}{p}|V_i|$.
  \end{enumerate}
  Note that $k=0$ and the sequences $A_0, V_0$ work, so some such maximal $k$ exists, and $k$ cannot be infinite, since $1\leq |V_i| = p^{-i}|V_0| = p^{n-i}$.

  How large can $k$ be? Induction shows that:
  \[\alpha_i \geq (1+\alpha/4)^i \alpha \geq (1+i\alpha/4)\alpha\]
  and in particular, after $i \geq \ceil{4/\alpha}$ steps, $\alpha_i \geq 2\alpha$. After another $\ceil{4/2\alpha}$ steps, $\alpha_i \geq 4\alpha$, and so on. Hence:
  \[k \leq \sum_{j=0}^{O(\log(1/\alpha))} \ceil{4/2^j\alpha} \leq \sum_{j=0}^\infty \ceil{4/2^j\alpha} \ll \alpha^{-1}\]
  We can assume in particular that
  \[k \leq \frac{n}{10}\]
  or else $n \ll \alpha^{-1}$, so $\alpha \ll \frac{1}{n}$ and we're done.

  Now apply \textbf{Lemma 2.6} to $A_k \subseteq V_k$. If the second conclusion of \textbf{Lemma 2.6} holds, then there exists $V' \leq V_k$ and $x \in V_k$ such that
  \[\frac{|(A_k-x)\cap V'|}{|V'|} \geq (1+\frac{\alpha_k}{4})\alpha_k\]
  But then we could let $A_{k+1} = (A_k-x)\cap V'$ and $V_{k+1} = V'$, contradicting the maximality of $k$. Hence the first conclusion must be held and
  \[\alpha_k \leq \frac{\sqrt{2}}{p^{n/2}} \implies p^{-n/4} <\alpha \leq  \alpha_k \ll \frac{1}{|V_k|^{\frac12}}\]
  By induction $|V_k| = p^{n-k} \geq p^{\frac{9}{10}n}$, and so $p^{-n/4} \ll p^{-9n/20}$, which is a contradiction.
\end{proof}
We now try to prove Meshulam's theorem. The strategy is to:
\begin{enumerate}
  \item Write the difference between the number of 3APs in $A$ and the expected number in a generic set of density $\alpha$ as an inner product involving $\one_A$ and the balanced function $\one_A-\alpha \one_G$.
  \item If $A$ has no nontrivial 3APs and is not too small, then this difference is large in absolute value.
  \item Apply Parseval's identity to this inner product.
  \item Deduce that there is some $\gamma \neq \one$ at which the Fourier transform of $\one_A - \alpha\one_G$ is large in absolute value.
  \item Use this large Fourier coefficient to get a density increment, by choosing $V'$ a subspace orthogonal to $\gamma$.
\end{enumerate}
\begin{proof}
  Think of $V$ as $\F_p^n$. We first note that 3APs are exactly the sets $\{x,y,z\}$ such that $x+y=2z$ (as $z-x = y-z$, if the AP is, in order, $x,z,y$).

  In these terms, a `trivial' 3AP (where $d=0$) corresponds to the trivial solutions $x=y=z$.

  Hence the number of 3APs in $A$ is
  \[\sum_{x,y,z \in A} \one_{x+y=2z} = \sum_{x,y \in A} \sum_{w \in 2\cdot A} \one_{x+y=w} = \sum_{w \in 2\cdot A} \one_A \ast \one_A(w) = \angle{\one_A \ast \one_A, \one_{2\cdot A}}\]
  where $2\cdot A$ is $A$ dilated by $2$, not $A+A$. Since $p$ is odd, $g \mapsto 2g$ is a bijection, so $|2\cdot A| = |A|$.

  We want to compare this to the expected count. Introduce the `first-order approximation' to $\one_A$ as $\alpha \cdot \one_G$. Note that this agrees with $\one_A$ on average, i.e. $\sum_x \one_A(x) = |A| = \alpha p^n = \sum_x \alpha \one_A(x)$. Then:
  \begin{align*}
    \angle{\alpha \one_G \ast \one_A, \one_{2\cdot A}} &= \alpha \angle{\one_G\ast \one_A, \one_{2\cdot A}}\\
    &= \alpha \angle{\one_G, \one_{2\cdot A} \circ \one_A}\\
    &= \alpha \sum_{x \in G}\sum_{a,b \in A} \one_{2a-b =x}\\
    &= \alpha|A|^2\\
    &= \alpha^3p^{2n}
  \end{align*}
  (Note that this is the expected number of 3APs in a random set of density $\alpha$)

  We will compare this to the actual count of 3APs in $A$.
  \begin{align*}
    \angle{\one_A\ast \one_A, \one_{2\cdot A}} - \angle{\alpha\one_G\ast \one_A, \one_{2\cdot A}} &= \angle{(\one_A-\alpha\one_G)\ast \one_A, \one_{2\cdot A}}\\
    &=\angle{F_A\ast \one_A, \one_{2\cdot A}}
  \end{align*}
  where $F_A = \one_A - \alpha\one_G$ is the ``balanced'' function.

  So $\angle{F_A\ast \one_A, \one_{2\cdot A}} = |A|-\alpha^3 p^{2n} = \alpha p^n(1-\alpha^2 p^n)$. In particular, if $|A| \geq (2p^n)^{1/2}$ (so that the first condition fails), then $1-\alpha^2p^n \leq -\frac{1}{2}\alpha^2p^n$, and
  \[|\angle{F_A \ast \one_A, \one_{2\cdot A}}| \geq \frac{1}{2}\alpha^3 p^{2n}\]

  We then use the theory about Fourier transforms:
  \begin{align*}
    \angle{F_A \ast \one_A, \one_{2\cdot A}} &= \angle{\widehat{F_A\ast \one_A}, \hat{\one_{2\cdot A}}}\\
    &= \angle{\hat{F_A}\cdot \hat{\one_A}, \hat{\one_{2\cdot A}}}\\
    &= \E_\gamma \hat{F_A}(\gamma)\hat{\one_A}(\gamma)\overline{\hat{\one_{2\cdot A}}(\gamma)}
  \end{align*}
  By the triangle inequality, $\E_\gamma |\hat{F_A}(\gamma)||\hat{\one_A}(\gamma)||\hat{\one_{2\cdot A}}(\gamma)| \geq \frac{1}{2}\alpha^3 p^{2n}$.

  Note that $\hat{F_A}(\one) = \sum_x F_A(x) = \sum_x (\one_A(x)-\alpha \one_G(x)) = |A| - \alpha |G| = 0$. Hence:
  \begin{align*}
    \E_{\gamma \neq \one} |\hat{F_A}(\gamma)||\hat{\one_A}(\gamma)||\hat{\one_{2\cdot A}}(\gamma)| &\geq \frac{1}{2}\alpha^3 p^{2n} \\
    &\leq (\sup_{\gamma \neq \one} |\hat{F_A}(\gamma)|)(\E_\gamma |\hat{\one_A}(\gamma)||\hat{\one_{2\cdot A}}(\gamma)|)
  \end{align*}
  By the Cauchy-Schwarz inequality,
  \begin{align*}
    \E_\gamma |\hat{\one_A}(\gamma)||\hat{\one_{2A}}(\gamma)| &\leq (\E_\gamma |\hat{\one_A}(\gamma)|^2)^{1/2}(\E_\gamma|\hat{\one_{2\cdot A}}(\gamma)|^2)^{1/2}\\
    &= \norm{\hat{\one_A}}_2 \cdot \norm{\hat{\one}_{2\cdot A}}_2 \\
    &= \norm{\one_A}_2 \cdot \norm{\one_{2\cdot A}}_2 \\
    &= |A|^{1/2} |2\cdot A|^{1/2} = |A| = \alpha p^n
  \end{align*}
  Hence
  \[\sup_{\gamma \neq \one}|\hat{F_A}(\gamma)| \geq \frac{1}{2}\alpha^2 p^n\]
  (Compare this to the trivial upper bound $|\hat{F_A}(\gamma)| \leq \sum_x |F_A(x)| \leq |A|+\alpha p^n = 2\alpha p^n$).

  Let $V' \leq \F_p^n$ be the subspace which `annihilates' $\gamma$. I.e., thinking of $\gamma:\F_p^n \to \C$, this means
  \[V' = \{x \in \F_p^n : \gamma(x) = 1\}\]
  or, thinking of $\gamma \in \F_p^n$ so the corresponding character is $x \mapsto e\left(\frac{\gamma\cdot x}{p}\right)$ where $e(z) = \exp(2\pi\im z)$, then
  \[V' = \{x \in \F_p^n : \gamma \cdot x = 0\}\]
  Then $V'$ is a subspace of codimension 1. The key observation is that $\gamma$ is constant on cosets of $V'$.

  We know that $|\hat{F_A}(\gamma)|$ is large. To relate this to $|A\cap (x+ V')|$, let $V_1', \ldots, V_p'$ be the cosets of $V'$. Then:
  \begin{align*}
    \hat{F_A}(\gamma) &= \sum_x(\one_A(x)-\alpha \one_G(x)) \overline{\gamma(x)}\\
    &= \sum_{i=1}^p\left( \sum_{x \in V_i'}(\one_A(x)-\alpha \one_G(x))\overline{\gamma(x)}\right)\\
    &= \sum_{i=1}^p \overline{\gamma(v_i)}(|A\cap V_i'| - \alpha p^{n-1})
  \end{align*}
  We want to say there exists some $i$ such that $|A\cap V_i'| - \alpha p^{n-1} \geq \frac{1}{4}\alpha^2 p^{n-1}$.

  Let $c \in \C$ such that $|\hat{F_A}(\gamma)| = c\hat{F_A}(\gamma)$, so $|c| = 1$, and consider $\angle{F_A, c\gamma+1}$.
  \begin{align*}
    \angle{F_A, c\gamma + 1} &= c \angle{F_A, \gamma} + \angle{F_A, 1}\\
    &= c\hat{F_A}(\gamma)\\
    &= |\hat{F_A}(\gamma)|
  \end{align*}
  Now note that $x \mapsto c\gamma(x)+1$ is constant on cosets of $V'$ - say it takes the value $x_i$ on $V_i'$. Split this inner product over $V_1', \ldots, V_p'$ as above:
  \[\angle{F_A, c\gamma+1} = \sum_i x_i \left(|A \cap V_i'| - \alpha p^{n-1}\right)\]
  Take real parts:
  \[\Re\angle{F_A, c\gamma +1} = \Re |\hat{F_A}(\gamma)| \geq \frac{1}{2}\alpha^2p^n\]
  So, by averaging, there is some $1 \leq i \leq p$ such that
  \[\Re(x_i)\left(|A\cap V_i'| - \alpha p^{n-1}\right) \geq \frac{1}{2}\alpha^2 p^{n-1}\]
  Finally, note that, since $x_i = c\gamma(v_i) +1$, and $c \gamma(v_i)$ is on $S^1$, we have $\Re(x_i) \in [0,2]$, and hence
  \[|A\cap V_i'| - \alpha p^{n-1} \geq \frac{1}{4}\alpha^2 p^{n-1}\]
\end{proof}
What goes wrong with this in $\Z/N\Z$? There is no large subgroup on which $\gamma(x) = 1$ (in particular, if $N$ is prime, there are no large subgroups at all!)

Instead, we will pass to the subset where $|\gamma(x)-1|\leq \epsilon$ for some small $\epsilon > 0$. These sets form `Bohr sets' - they act like subspaces even when there aren't any.
\end{document}
